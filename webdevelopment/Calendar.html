<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Calendar</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="style.css">
        <link rel="stylesheet" href="nav.css">
        <link rel="stylesheet" href="./CSS/aos.css">
        <link rel="icon" type="image/x-icon" href="Images/icons/favicon.ico">
        <script src="script.js" defer></script>
        <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
        <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.1/dist/umd/supabase.min.js"></script>
    </head>
    <body>
        <div id="preloader">
            <div class="preloader-content">
                <img src="Images/logo.png" alt="Logo" class="preloader-logo">
            </div>
        </div>
    
        <!-- Header -->
        <header>
            <div id="slideshow-container">
                <div class="slideshow-bg bg1"></div>
                <div class="slideshow-bg bg2"></div>
                <div class="slideshow-bg bg3"></div>
                <div class="slideshow-bg bg4"></div>
                <div class="header">
                    <img src="./Images/logo.png" alt="logo">
                </div>
            </div>
        </header>
    
        <!-- Navigation -->
        <nav>
            <input type="checkbox" id="toggle-menu" class="hamburger-menu">
            <label for="toggle-menu" class="hamburger-menu-icon">
                <div class="line"></div>
                <div class="line"></div>
                <div class="line"></div>
            </label>
            <ul class="navbarul">
                <li class="home"><a href="index.html">Home</a></li>
                <li class="about"><a href="About.html">About Me</a></li>
                <li class="dropdown">
                    <a href="Projects_Combined.html"  class="dropbtn">Projects</a>
                    <div class="dropdown-content" name="nav-drop">
                        <a href="Projects_Combined.html#project1">Project 1</a>
                        <a href="Projects_Combined.html#project2">Project 2</a>
                        <a href="Projects_Combined.html#project3">Project 3</a>
                        <a href="Projects_Combined.html#exampleslist">Example Sites</a>
                    </div>
                </li>
                <li class="calendar"><a href="Calendar.html" class="active">Calendar</a></li>
                <li class="reflect"><a href="Reflection.html">Reflection</a></li>
                <li class="contact"><a href="Contact.html">Contact</a></li>
                <div class="dark-toggle-container">
                    <label class="theme-toggle">
                    <input type="checkbox" id="theme-toggle">
                    <span class="toggle-slider"></span>
                    </label>
                </div>
            </ul>
        </nav>

        <!-- Main -->
        <main>
            <div class="legend">
                <strong>Legend:</strong>
                <span style="color:#007BFF;">● School</span>
                <span style="color:#28a745;">● Work</span>
                <span style="color:#e83e8c;">● Personal</span>
                <span style="color:#6c757d;">● Other</span>
            </div>
            
            
            <div id="calendar"></div>
            
            <!-- Modal Form -->
            <div class="modal" id="eventModal">
                <div class="modal-content">
                    <h3>Add Event</h3>
                    <input id="eventTitle" placeholder="Title" />
                    <select id="eventCategory">
                        <option value="school">School</option>
                        <option value="work">Work</option>
                        <option value="personal">Personal</option>
                        <option value="other">Other</option>
                    </select>
                    <input id="eventStart" type="datetime-local" />
                    <input id="eventEnd" type="datetime-local" />
                    <label><input id="eventAllDay" type="checkbox" /> All Day</label><br>
                    <button onclick="submitEvent()">Add</button>
                    <button onclick="closeModal()">Cancel</button>
                </div>
            </div>

            <div class="export-buttons">
                <button onclick="exportJSON()">Export JSON</button>
                <button onclick="exportICS()">Export ICS</button>
            </div>
        </main>
        
        <!-- Footer -->
        <footer class="footer reflexive">
            <div class="footer-slideshow-container">
                <div class="footer-slideshow-bg bg1"></div>
                <div class="footer-slideshow-bg bg2"></div>
                <div class="footer-slideshow-bg bg3"></div>
                <div class="footer-slideshow-bg bg4"></div>
            </div>
            <div class="footer-container">
                <div class="footer-column">
                    <h3>Phone</h3>
                    <p><span><img src="Images/icons/phone_icon.png" alt="Phone Icon" class="footer-icon"></span>: 812-480-4387</p>
                </div>
                <div class="footer-column">
                    <h3>Email</h3>
                    <p><span><img src="Images/icons/email_icon.png" alt="Email Icon" class="footer-icon"></span>: Emwuerth216@gmail.com</p>
                    <p><span><img src="Images/icons/email_icon.png" alt="Email Icon" class="footer-icon"></span>: Emwcd7@umsystem.edu</p>
                </div>
                <div class="footer-column">
                    <h3>Follow Me</h3>
                    <p>
                        <button class="linkedIn"><a href="https://www.linkedin.com/in/eliwuerth/" target="_blank"><img src="./Images/icons/InBug-White.png" alt="logo" class="footer-icon"></a></button>
                        <button class="linkedIn"><a href="https://github.com/EliWuerth" target="_blank"><img src="./Images/icons/github-mark-white.png" alt="logo" class="footer-icon"></a></button>
                    </p>
                </div>
                <div class="footer-column">
                    <h3>Copyright</h3>
                    <p>&copy; 2025 Eli Wuerth. All rights reserved.</p>
                </div>
            </div>
        </footer>

        <!-- Script -->
        <script>
            const supabase = window.supabase.createClient('https://ygyptsrakiypcosyxfuq.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlneXB0c3Jha2l5cGNvc3l4ZnVxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3NjMyOTYsImV4cCI6MjA2NTMzOTI5Nn0.qNIxUZnwFBrXhMUEJuvYfRM6jeSLC1Q-J0Yav1AosXs');

            const categoryColors = {
                school: '#007BFF',
                work: '#28a745',
                personal: '#e83e8c',
                other: '#6c757d'
            };

            let calendar, startInfo = null;

            document.addEventListener('DOMContentLoaded', async function () {
                const calendarEl = document.getElementById('calendar');
                const { data: events } = await supabase.from('events').select('*');

                calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    selectable: true,
                    editable: false,
                    eventSources: [
                    {
                        url: 'https://calendar.google.com/calendar/ical/emwuerth216%40gmail.com/private-480172a2fcb7552088fdd47654006067/basic.ics',
                        format: 'ics'
                    },
                    {
                        events: events.map(e => ({
                        id: e.id,
                        title: e.title,
                        start: e.start,
                        end: e.end,
                        allDay: e.all_day,
                        backgroundColor: e.color
                        })),
                        id: 'supabase'
                    }
                    ],
                    select: function (info) {
                        startInfo = info;
                        openModal();
                    },
                    eventClick: async function (info) {
                        if (info.event.source?.id === 'supabase' && confirm("Delete this event?")) {
                            await supabase.from('events').delete().eq('id', info.event.id);
                            info.event.remove();
                        }
                    }
                });

                function exportJSON() {
                    const events = calendar.getEvents().filter(e => e.source?.id === 'supabase').map(e => ({
                        title: e.title,
                        start: e.startStr,
                        end: e.endStr,
                        allDay: e.allDay,
                        backgroundColor: e.backgroundColor
                    }));
                    const blob = new Blob([JSON.stringify(events, null, 2)], { type: 'application/json' });
                    downloadBlob(blob, 'events.json');
                }

                function exportICS() {
                    const events = calendar.getEvents().filter(e => e.source?.id === 'supabase');
                    let ics = `BEGIN:VCALENDAR\nVERSION:2.0\nCALSCALE:GREGORIAN\n`;
                    events.forEach(e => {
                        ics += `BEGIN:VEVENT\nSUMMARY:${e.title}\nDTSTART:${formatICS(e.start)}\n`;
                        if (e.end) ics += `DTEND:${formatICS(e.end)}\n`;
                        ics += `END:VEVENT\n`;
                    });
                    ics += `END:VCALENDAR`;
                    downloadBlob(new Blob([ics], { type: 'text/calendar' }), 'events.ics');
                }

                function formatICS(date) {
                    return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                }

                function downloadBlob(blob, filename) {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }

            calendar.render();
            });

            function openModal() {
                document.getElementById('eventModal').style.display = 'block';
                document.getElementById('eventTitle').value = '';
                document.getElementById('eventStart').value = startInfo.startStr;
                document.getElementById('eventEnd').value = startInfo.endStr;
                document.getElementById('eventAllDay').checked = true;
            }

            function closeModal() {
                document.getElementById('eventModal').style.display = 'none';
            }

            async function submitEvent() {
                const title = document.getElementById('eventTitle').value;
                const cat = document.getElementById('eventCategory').value;
                const start = document.getElementById('eventStart').value;
                const end = document.getElementById('eventEnd').value;
                const allDay = document.getElementById('eventAllDay').checked;
                const color = categoryColors[cat] || '#cd7f32';

                const { data, error } = await supabase.from('events').insert([{
                    title: title,
                    start: start,
                    end: end,
                    all_day: allDay,
                    color: color
                }]).select();

                if (!error && data.length > 0) {
                    calendar.addEvent({
                    id: data[0].id,
                    title: title + ` (${cat})`,
                    start: start,
                    end: end,
                    allDay: allDay,
                    backgroundColor: color
                    });
                }

            closeModal();
            }
        </script>
    </body>
</html>